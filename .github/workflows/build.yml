name: Build

on:
  pull_request:
  push:
    branches:
      - main
      - master

env:
  PLUGIN_VERSION: "0.1.${{ github.run_number }}"

permissions:
  contents: write

jobs:
  # ── Build the Roblox plugin ─────────────────────────────────────────────
  build-plugin:
    name: Build .rbxm
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rojo
        run: |
          ROJO_VERSION="7.5.1"
          curl -L "https://github.com/rojo-rbx/rojo/releases/download/v${ROJO_VERSION}/rojo-${ROJO_VERSION}-linux-x86_64.zip" -o rojo.zip
          unzip rojo.zip
          chmod +x rojo
          sudo mv rojo /usr/local/bin/rojo

      - name: Build plugin
        run: rojo build default.project.json --output RobloxMcpBridge.rbxm

      - name: Upload plugin artifact
        uses: actions/upload-artifact@v4
        with:
          name: plugin
          path: RobloxMcpBridge.rbxm
          retention-days: 7

  # ── Build standalone install executables ────────────────────────────────
  build-installer-linux:
    name: Build installer (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Build
        run: |
          pip install pyinstaller
          pyinstaller --onefile --name install-linux install.py
      - uses: actions/upload-artifact@v4
        with:
          name: installer-linux
          path: dist/install-linux
          retention-days: 7

  build-installer-macos:
    name: Build installer (macOS)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Build
        run: |
          pip install pyinstaller
          pyinstaller --onefile --name install-macos install.py
      - uses: actions/upload-artifact@v4
        with:
          name: installer-macos
          path: dist/install-macos
          retention-days: 7

  build-installer-windows:
    name: Build installer (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Build
        run: |
          pip install pyinstaller
          pyinstaller --onefile --name install-windows install.py
      - uses: actions/upload-artifact@v4
        with:
          name: installer-windows
          path: dist/install-windows.exe
          retention-days: 7

  # ── Release (main branch only) ──────────────────────────────────────────
  release:
    name: Create Release
    runs-on: ubuntu-latest
    if: github.ref_name == github.event.repository.default_branch
    needs:
      - build-plugin
      - build-installer-linux
      - build-installer-macos
      - build-installer-windows

    steps:
      - uses: actions/checkout@v4

      - name: Collect all artifacts
        uses: actions/download-artifact@v4
        with:
          path: output
          merge-multiple: true

      # Also include install.py as-is for users who already have Python
      - name: Add install.py to release files
        run: cp install.py output/install.py

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.PLUGIN_VERSION }}
          name: Release v${{ env.PLUGIN_VERSION }}
          generate_release_notes: true
          body: |
            ## Installation

            **Option A — You have Python 3.8+:**
            ```bash
            python install.py
            ```

            **Option B — Standalone installer (no Python needed):**
            - **Linux:** download `install-linux`, then `chmod +x install-linux && ./install-linux`
            - **macOS:** download `install-macos`, then `chmod +x install-macos && ./install-macos`
            - **Windows:** download `install-windows.exe` and double-click

            **Manual plugin install only:**
            Download `RobloxMcpBridge.rbxm` and place it in your Roblox Plugins folder.
          files: |
            output/RobloxMcpBridge.rbxm
            output/install.py
            output/install-linux
            output/install-macos
            output/install-windows.exe
